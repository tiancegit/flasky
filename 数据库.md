##数据库

数据库按照一定的规则保存程序数据,程序再发起查询取回所需的数据.Web程序最常用的基于关系模型的数据库.这种数据库也称为SQL数据库,因为他们使用结构化查询语言.  
不过这几年文档数据库和键值对数据库成了流行的替代选择,这两种数据库合称为NoSQL数据库.

##SQL数据库

关系型数据库把数据存储在表中,表模拟程序中不同的实体,例如,订单管理程序的数据库中可能有表customers, product和orders.

表的列数是固定的,行数是可变的,列定义表所表示的实体的数据属性,例如,customers表中可能有name,address,phone等列.表中的行定义各别对应的真实数据.

表中有个特殊的列,称为主键,其值为表中各行唯一的标示符.表中还可以有称为外键的列,引用同一个表或不同表中某行的主键,行之间的这种联系称为关系,这是关系型数据库的基础.  


##NoSQL数据库
不遵循上述关系模型的数据库统称为NoSQL数据库,NoSQL数据库一般使用集合代替表,使用文档代替记录.NoSQL数据库采用的设计方式使联结变得困难,所以大多数表都不支持这种操作,  
减少了表的数量,却增加了数据量.这种结构的数据库要把角色名存储在每个用户中,如此一来,将角色重命名的操作就变得很耗时.可能需要更新大量的文档.  
使用NoSQL数据库也有好处,数据重复可以提升查询速度.列出用户及其角色的操作很简单,因为无需联结.

###使用SQL还是NoSQL

SQL数据库擅于用于高效且紧凑的形式存储结构化数据,这种数据库需要花费大量的精力保证数据的一致性,NoSQL数据库放宽了对与这种一致性的要求,从而获得了性能上的优势.  
对于中小型程序来说,SQL和NoSQL数据库都是很好的选择,而且性能相当.

##python数据库框架

选择数据库时要考虑很多因素
* 易用性
* 性能
* 可移植性
* Flask集成度


##使用 Flask-SQLAlchemy管理数据库
Flask-SQLAlchemy管理数据库是一个Flask扩展,简化了在Flask程序中使用SQLAlchemy的操作,SQLAlchemy 是一个强大的关系型数据库,支持多种数据库后台,SQLAlchemy提供了 
高层ORM,也提供了使用数据库原生SQL的低层功能.

和其它扩展一样,Flask-SQLAlchemy使用pip安装:  
$ pip install flask-sqlalchemy

在Flask-SQLAlchemy张,数据库用 URL指定,最流行的数据库引擎采用的数据库url格式如表所示,

```
数据库引擎             URL
MySQL             mysql://username:password@hostname/database
Postgres          postgresql://username:password@hostname/database
SQLite(Unix)      sqlite:////absolute/path/to/database
SQLite(windows)   sqlite:///c://absolute/path/to/database
```

在这些url中,hostname表示MySQl服务所在的主机,可以是本地主机也可以是远程服务器,数据库服务器上可以托管多个数据库,因此database表示要使用的数据库名.如果数据库要认证,  
username和password表示数据库用户密令.

SQLite数据库不需要使用服务器,因此不用指定hostname,username 和 password. URL中的database是硬盘上文件的文件名.

程序使用的数据库URL必须保存到Flask配置对象的SQLALCHEMY_DATABASE_URL键中,配置对象中还有一个很有用的选项,即 SQLALCHEMY_COMMIT_ON_TEARDOWN键,将其设为True时,  
每次请求结束后都会自动提交数据库中的变动,其它配置选项的作用请参阅Flask-SQLAlchemy文档,下例初始化及配置了一个简单的SQLite数据库.

配置数据库, hello.py

```
from flask_sqlalchemy import SQLAlchemy
import os

basedir = os.path.abspath(os.path.dirname(__file__))  #获取文件路径
app.config['SQLALCHEMY_DATABASE_URL'] = 'sqlite:////' + os.path.join(basedir, 'data.sqlite')
app.config["SQLALCHEMY_COMMIT_ON_TEARDOWM"] = True
```
db对象是SQLAlchemy类的实例,表示程序使用的数据库,同时还获得Flask-SQLAlchemy提供的所有功能.

##定义模型
模型这个术语表示程序使用的持久化实体,在ORM中,模型一般是一个Python类,类中的属性对应数据库中表中的列.  

Flask_SQLAlchemy创建的数据库实例为模型提供了一个基类以及一系列辅助类和辅助函数,用于定义模型的结构,roles表和users表可以定义为Role和User.
如下所示,   hello.py 定义Role和User模型
```python
class Role(db.Model):      # 定义Role模型和User模型
    __tablename__ = 'roles'
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(64), unique=True)

    def __repr__(self):
        return '<Role %r>' % self.name

class User(db.Model):
    __tablename__ = 'users'
    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(64), unique=True, index=True)

    def __repr__(self):
        return '<User %r>' % self.username
```

类变量__tablename__定义在数据库中使用的表名,如果没有定义__tablename__,Flask-SQLAlchemy会使用一个默认的名字,但默认的表名没有遵循使用  
复数形式进行命名的约定.所以最好我们自己来指定表名,其余的类变量都是该模型的属性,被定义为db.Column类的实例.

db.Column类构造的第一个函数是数据库列和模型属性的类型,下表中列出了一些可用的列类型以及在模型中使用的Python模型.

最常用的SQLALchemy列类型

```
类型名           Python类型           说明 
Integer         int               普通整数,一般是32位
SmallInterger   int               取值范围小的整数,一般是16位.
BigInterger     int或long         不限制精度的整数
Float           float             浮点数
Numeric         decimal.Decimal   定点数
String          str               变长字符串
Text            str               变长字符串,对较长的或者不限长度的字符串做了优化
Unicode         unicode           变长Unicode字符串
UnicodeText     unicode           变长Unicode字符串,对于较长的或不限长度的字符串做了优化
Boolean         bool              布尔值
Date            datetime.date     日期
Time            datetime.time     时间
DateTime        datetime.datetime 日期和时间
Interval        datetime.timedelta 时间间隔
Enum            str               一组字符串
PickleType      任何Python对象     自动使用Pickle序列化
LargeBinary     str               二进制文件
```
db.Column中其余的参数指定属性的配置选项,下表列出了一些可用的选项

最常使用的SQLAlchemy列选项
```
选项名          说明  
primary_key    如果设为True,这列就是表的主键
unique         如果设为True,这列不允许出现重复的键
index          如果设为True,为这列创建索引,提升查询效率
nullable       如果设为True,这列允许使用空值,如果设为False,这列不允许使用空值
default        为这列设置默认值
```

Flask-SQLAlchemy要求每个模型都要定义主键,这一列通常命名为id.虽然没有强制要求,但这两个模型都定义了__repr__()方法,返回一个具有可读性  
的字符表示模型,可在调试和测试的时候使用.

## 关系

